@page "/search"
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider authStateProvider
@inject PokémonService pokémonService
@using System.Security.Claims;
@using System.Text;
@using Front.Components.Widget
@using PokéService.Entities;

<div id="main">
<link rel="stylesheet" href="style.css" />

<PageTitle>Recherche</PageTitle>

<h1>Recherche</h1>
<InputText @bind-Value="searchModel.Name" @onchange="SearchPkmn"/>

<label for="cat">Type de carte:</label>
<InputSelect id="cat" class="form-control" @bind-Value="searchModel.Category" @onchange="SearchPkmn">
    <option value="">Tous</option>
    <option value="0">Pokémon</option>
    <option value="1">Energie</option>
    <option value="2">Dresseur</option>
</InputSelect>

<label for="t1">Type du pokémon:</label>
<InputSelect id="t1" class="form-control" @bind-Value="searchModel.Type1" @onchange="SearchPkmn">
    <option value="">Tous</option>
    <option value="Incolore">Incolore</option>
    <option value="Plante">Plante</option>
    <option value="Eau">Eau</option>
    <option value="Feu">Feu</option>
    <option value="Électrique">Électrique</option>
    <option value="Métal">Métal</option>
    <option value="Psy">Psy</option>
    <option value="Combat">Combat</option>
    <option value="Obscurité">Obscurité</option>
    <option value="Dragon">Dragon</option>
    <option value="Fée">Fée</option>
</InputSelect>

<label for="t2">Type du pokémon:</label>
<InputSelect id="t2" class="form-control" @bind-Value="searchModel.Type2" @onchange="SearchPkmn">
    <option value="">Tous</option>
    <option value="Incolore">Incolore</option>
    <option value="Plante">Plante</option>
    <option value="Eau">Eau</option>
    <option value="Feu">Feu</option>
    <option value="Électrique">Électrique</option>
    <option value="Métal">Métal</option>
    <option value="Psy">Psy</option>
    <option value="Combat">Combat</option>
    <option value="Obscurité">Obscurité</option>
    <option value="Dragon">Dragon</option>
    <option value="Fée">Fée</option>
</InputSelect>

    
<label for="set">Set de carte:</label>
<InputSelect id="set" class="form-control" @bind-Value="searchModel.Set" @onchange="SearchPkmn">
    <option value="">Tous</option>
    <option value="EX Île des Dragons">EX Île des Dragons</option>
    <option value="Règne de Glace">Règne de Glace</option>
    <option value="Éclipse Cosmique">Éclipse Cosmique</option>
    <option value="Expedition">Expedition</option>
    <option value="Impulsion Turbo">Impulsion Turbo</option>
    <option value="Neo Genesis">Neo Genesis</option>
    <option value="POP Série 4">POP Série 4</option>
    <option value="Éveil des Légendes">Éveil des Légendes</option>
    <option value="EX Tempête de sable">EX Tempête de sable</option>
    <option value="EX Gardiens de Cristal">EX Gardiens de Cristal</option>
    <option value="Harmonie des Esprits">Harmonie des Esprits</option>
    <option value="Explosion Plasma">Explosion Plasma</option>
    <option value="Neo Revelation">Neo Revelation</option>
    <option value="Tempête Argentée">Tempête Argentée</option>
    <option value="Set de Base">Set de Base</option>
    <option value="Tempète Plasma">Tempète Plasma</option>
    <option value="Promo XY">Promo XY</option>
    <option value="EX Rouge Feu & Vert Feuille">EX Rouge Feu & Vert Feuille</option>
    <option value="Ténèbres Embrasées">Ténèbres Embrasées</option>
    <option value="HeartGold SoulSilver">HeartGold SoulSilver</option>
    <option value="Dragons Éxaltés">Dragons Éxaltés</option>
    <option value="Promo DP">Promo DP</option>
    <option value="Rivaux Émergeants">Rivaux Émergeants</option>
    <option value="Platine">Platine</option>
    <option value="Double Danger">Double Danger</option>
    <option value="Déchaînement">Déchaînement</option>
    <option value="Ciel Rugissant">Ciel Rugissant</option>
    <option value="Évolution Céleste">Évolution Céleste</option>
    <option value="Wizards Black Star Promos">Wizards Black Star Promos</option>
    <option value="Lumière Interdite">Lumière Interdite</option>
    <option value="Indomptable">Indomptable</option>
    <option value="Célébrations">Célébrations</option>
    <option value="Épée et Bouclier">Épée et Bouclier</option>
    <option value="Impact des Destins">Impact des Destins</option>
    <option value="EX Fantômes Holon">EX Fantômes Holon</option>
    <option value="Rupture Turbo">Rupture Turbo</option>
    <option value="Aquapolis">Aquapolis</option>
    <option value="Destinées Futures">Destinées Futures</option>
    <option value="Flammes Obsidiennes">Flammes Obsidiennes</option>
    <option value="Promo SWSH">Promo SWSH</option>
    <option value="Noir & Blanc">Noir & Blanc</option>
    <option value="POP Série 7">POP Série 7</option>
    <option value="Aube Majestueuse">Aube Majestueuse</option>
    <option value="Bienvenue à Kalos">Bienvenue à Kalos</option>
    <option value="Promo SM">Promo SM</option>
    <option value="Alliance Infaillible">Alliance Infaillible</option>
    <option value="Générations">Générations</option>
    <option value="Tempête">Tempête</option>
    <option value="Explorateurs Obscurs">Explorateurs Obscurs</option>
    <option value="POP Série 2">POP Série 2</option>
    <option value="Soleil et Lune">Soleil et Lune</option>
    <option value="Tempête Céleste">Tempête Céleste</option>
    <option value="Merveilles Secrètes">Merveilles Secrètes</option>
    <option value="Duels au Sommets">Duels au Sommets</option>
    <option value="Trésors Mystérieux">Trésors Mystérieux</option>
    <option value="Invasion Carmin">Invasion Carmin</option>
    <option value="Styles de combat">Styles de combat</option>
    <option value="Détective Pikachu">Détective Pikachu</option>
    <option value="Promo BW">Promo BW</option>
    <option value="Offensive Vapeur">Offensive Vapeur</option>
    <option value="EX Dragon">EX Dragon</option>
    <option value="Carte Alternative A Jaune">Carte Alternative A Jaune</option>
    <option value="POP Série 3">POP Série 3</option>
    <option value="Gardiens Ascendants">Gardiens Ascendants</option>
    <option value="Jungle">Jungle</option>
    <option value="Triomphant">Triomphant</option>
    <option value="Étincelles">Étincelles</option>
    <option value="Duo de Choc">Duo de Choc</option>
    <option value="Stars Étincelantes">Stars Étincelantes</option>
    <option value="XY">XY</option>
    <option value="Voltage Éclatant">Voltage Éclatant</option>
    <option value="EX Deoxys">EX Deoxys</option>
    <option value="Évolutions à Paldea">Évolutions à Paldea</option>
    <option value="Coffre des Dragons">Coffre des Dragons</option>
    <option value="EX Team Magma vs Team Aqua">EX Team Magma vs Team Aqua</option>
    <option value="Diamant & Perle">Diamant & Perle</option>
    <option value="Frontières Franchies">Frontières Franchies</option>
    <option value="POP Série 1">POP Série 1</option>
    <option value="Fossile">Fossile</option>
    <option value="L'appel des Légendes">L'appel des Légendes</option>
    <option value="Pokémon GO">Pokémon GO</option>
    <option value="EX Gardiens du Pouvoir">EX Gardiens du Pouvoir</option>
    <option value="Ombres Ardentes">Ombres Ardentes</option>
    <option value="Ultra-Prisme">Ultra-Prisme</option>
    <option value="Pouvoirs Émergents">Pouvoirs Émergents</option>
    <option value="Tonnerre Perdu">Tonnerre Perdu</option>
    <option value="EX Légendes Oubliées">EX Légendes Oubliées</option>
    <option value="POP Série 9">POP Série 9</option>
    <option value="Écarlate et Violet">Écarlate et Violet</option>
    <option value="Astres Radieux">Astres Radieux</option>
    <option value="Platine Platine">Platine Platine</option>
    <option value="Nobles Victoires">Nobles Victoires</option>
    <option value="151">151</option>
    <option value="EX Rubis & Saphir">EX Rubis & Saphir</option>
    <option value="Évolutions">Évolutions</option>
    <option value="Zénith Suprême">Zénith Suprême</option>
    <option value="Destinées Occultes">Destinées Occultes</option>
    <option value="La Voie du Maître">La Voie du Maître</option>
    <option value="Team Rocket">Team Rocket</option>
    <option value="Glaciation Plasma">Glaciation Plasma</option>
    <option value="Déstinées Radieuses">Déstinées Radieuses</option>
    <option value="Vainqueurs Suprêmes">Vainqueurs Suprêmes</option>
    <option value="Poings Furieux">Poings Furieux</option>
    <option value="Primo-Choc">Primo-Choc</option>
    <option value="EX Émeraude">EX Émeraude</option>
    <option value="Origines Antiques">Origines Antiques</option>
    <option value="EX Forces Cachées">EX Forces Cachées</option>
    <option value="Origine Perdue">Origine Perdue</option>
    <option value="Neo Discovery">Neo Discovery</option>
    <option value="Clash des Rebelles">Clash des Rebelles</option>
    <option value="Vigueur Spectrale">Vigueur Spectrale</option>
    <option value="Faille Paradoxe">Faille Paradoxe</option>
    <option value="EX Créateurs de légendes">EX Créateurs de légendes</option>
    <option value="EX Espèces Delta">EX Espèces Delta</option>
    <option value="Neo Destiny">Neo Destiny</option>
    <option value="Poing de Fusion">Poing de Fusion</option>
</InputSelect>

<button @onclick="SearchPkmn">
    Search
</button>

<div class="row">
    @foreach (var pokémon in pokémons)
	{
		<div class="col-3">
			<CardItem pokémon="@pokémon" />
		</div>
	}
</div>
</div>

@code {

    public SearchModel searchModel = new();

    public List<Pokémon> pokémons = new();

    public async Task<int> SearchPkmn()
    {
        var pk = await pokémonService.Search(searchModel.ToQuery());
        if (searchModel.Page == 1)
			pokémons.Clear();

        if (pk != null) 
            pokémons.AddRange(pk);

        return pokémons.Count;
    }

    public class SearchModel
    {
        public string Name { get; set; } = "";
        public string Category { get; set; } = "";
        public string Type1 { get; set; } = "";
        public string Type2 { get; set; } = "";
        public string Set { get; set; } = "";
        public int Page { get; set; } = 0;
        public int PageSize { get; set; } = 50;

        private int lastHash { get; set; } = -1;

        public void Reset() => Page = 0; 

        public string ToQuery()
        {
            var h = GetHash();
            if (h != lastHash)
            {
                Reset(); // if research change, reset page
                lastHash = h;
            }

            StringBuilder s = new("?");
            if (!string.IsNullOrEmpty(Name)) s.Append($"name={Name}&");
            if (!string.IsNullOrEmpty(Category)) s.Append($"category={Category}&");
            if (!string.IsNullOrEmpty(Type1)) s.Append($"type1={Type1}&");
            if (!string.IsNullOrEmpty(Type2)) s.Append($"type2={Type2}&");
            if (!string.IsNullOrEmpty(Set)) s.Append($"set={Set}&");

            s.Append($"offset={Page++ * PageSize}&limit={PageSize}");

			return s.ToString();
        }

        public int GetHash()
		{
            return Name.GetHashCode() + Category.GetHashCode() + Type1.GetHashCode() + Type2.GetHashCode() + Set.GetHashCode();
		}
    }
}